diff --git a/R/polyreg.R b/R/polyreg.R
index 402a6e8b9c19688fcab2d1e13b4c9234fd624001..ef13fa92904130cc9e9190404a9eaf781796e50f 100644
--- a/R/polyreg.R
+++ b/R/polyreg.R
@@ -216,223 +216,94 @@ polyreg <- function(
       formula = nuisance.model,
       data = normalized_data,
       exposure = exposure,
       data.initial.values = data.initial.values,
       estimand = estimand,
       specific.time = estimand$time.point,
       outcome.type = outcome.type,
       prob.bound = prob.bound
     )
   } else if (outcome.type == "PROPORTIONAL" || outcome.type == "POLY-PROPORTIONAL") {
     alpha_beta_0 <- getInitialValuesProportional(
       formula = nuisance.model,
       data = normalized_data,
       outcome.type = outcome.type,
       exposure = exposure,
       estimand = estimand,
       data.initial.values = data.initial.values,
       prob.bound = prob.bound,
       out_normalizeCovariate = out_normalizeCovariate
     )
   }
 
   #######################################################################################################
   # 3. Calculating IPCW (function: calculateIPCW, calculateIPCWMatrix)
   #######################################################################################################
-  if (outcome.type == "COMPETING-RISK" | outcome.type == "SURVIVAL") {
+  ip.weight <- NULL
+  ip.weight.matrix <- NULL
+  if (outcome.type %in% c("COMPETING-RISK", "SURVIVAL")) {
     ip.weight <- calculateIPCW(nuisance.model, normalized_data, code.censoring, strata, estimand$time.point)
   } else if (outcome.type == "BINOMIAL") {
-    ip.weight <- rep(1,nrow(normalized_data))
-  } else if (outcome.type == "PROPORTIONAL" | outcome.type == "POLY-PROPORTIONAL") {
+    ip.weight <- rep(1, nrow(normalized_data))
+  } else if (outcome.type %in% c("PROPORTIONAL", "POLY-PROPORTIONAL")) {
     ip.weight.matrix <- calculateIPCWMatrix(nuisance.model, normalized_data, code.censoring, strata, estimand, out_normalizeCovariate)
   }
 
   #######################################################################################################
   # 4. Parameter estimation (functions: estimating_equation_ipcw, _survival, _proportional)
   #######################################################################################################
-  makeObjectiveFunction <- function() {
-    out_ipcw <- list()
-    initial.CIFs <- NULL
-      call_and_capture <- function(fun, ...) {
-      out_ipcw <<- do.call(fun, list(...))
-      out_ipcw$ret
-      }
-      estimating_equation_i <- function(p) call_and_capture(
-        estimating_equation_ipcw,
-        formula = nuisance.model, data = normalized_data, exposure = exposure,
-        ip.weight = ip.weight, alpha_beta = p, estimand = estimand,
-        optim.method = optim.method, prob.bound = prob.bound,
-        initial.CIFs = initial.CIFs
-      )
-      estimating_equation_s <- function(p) call_and_capture(
-      estimating_equation_survival,
-      formula = nuisance.model, data = normalized_data, exposure = exposure,
-      ip.weight = ip.weight, alpha_beta = p, estimand = estimand,
-      prob.bound = prob.bound, initial.CIFs = initial.CIFs
-    )
-      estimating_equation_p <- function(p) call_and_capture(
-      estimating_equation_proportional,
-      formula = nuisance.model, data = normalized_data, exposure = exposure,
-      ip.weight.matrix = ip.weight.matrix, alpha_beta = p, estimand = estimand,
-      optim.method = optim.method, prob.bound = prob.bound,
-      initial.CIFs = initial.CIFs
-    )
-      estimating_equation_pp <- function(p) call_and_capture(
-      estimating_equation_pproportional,
-      formula = nuisance.model, data = normalized_data, exposure = exposure,
-      ip.weight.matrix = ip.weight.matrix, alpha_beta = p, estimand = estimand,
-      optim.method = optim.method, prob.bound = prob.bound,
-      initial.CIFs = initial.CIFs
-    )
-    setInitialCIFs <- function(new.CIFs) initial.CIFs <<- new.CIFs
-    getResults     <- function() out_ipcw
-      list(
-      estimating_equation_i = estimating_equation_i,
-      estimating_equation_s = estimating_equation_s,
-      estimating_equation_p = estimating_equation_p,
-      estimating_equation_pp = estimating_equation_pp,
-      setInitialCIFs = setInitialCIFs,
-      getResults = getResults
-    )
-  }
-
-  assessConvergence <- function(new_params, current_params, current_obj_value, optim.parameter1, optim.parameter2, optim.parameter3) {
-    if (any(abs(new_params) > optim.parameter3)) {
-      stop("Estimates are either too large or too small, and convergence might not be achieved.")
-    }
-    param_diff <- abs(new_params - current_params)
-    max.absolute.difference <- max(param_diff)
-    relative.difference <- assessRelativeDifference(new_params, current_params)
-    obj_value <- get_obj_value(new_params)
-    converged <- (relative.difference <= optim.parameter1) || (obj_value <= optim.parameter2) || is_stalled(c(current_obj_value, obj_value))
-
-    criteria1 <- (relative.difference <= optim.parameter1)
-    criteria2 <- (obj_value <= optim.parameter2)
-    criteria3 <- is_stalled(c(current_obj_value, obj_value))
-    converged  <- (criteria1 || criteria2 || criteria3)
-    converged.by <- if (!converged) NA_character_
-    else if (criteria1) "Converged in relative difference"
-    else if (criteria2) "Converged in objective function"
-    else "Stalled"
-
-    list(converged = converged, converged.by=converged.by, relative.difference = relative.difference, max.absolute.difference = max.absolute.difference, obj_value = obj_value)
-  }
-
-  assessRelativeDifference <- function(new, old) {
-    max(abs(new - old) / pmax(1, abs(old)))
-  }
-
-  is_stalled <- function(x, stall_patience=3, eps=1e-3) {
-    if (length(x) < stall_patience) return(FALSE)
-    recent <- tail(x, stall_patience)
-    (diff(range(recent)) / max(1e-12, mean(recent))) <= eps
-  }
-
-  choose_estimating_equation <- function(outcome.type, obj) {
-    if (outcome.type == "COMPETING-RISK") {
-      obj$estimating_equation_i
-    } else if (outcome.type == "SURVIVAL" | outcome.type == "BINOMIAL") {
-      obj$estimating_equation_s
-    } else if (outcome.type == "PROPORTIONAL") {
-      obj$estimating_equation_p
-    } else if (outcome.type == "POLY-PROPORTIONAL") {
-      obj$estimating_equation_pp
-    } else {
-      stop("Unknown outcome.type: ", outcome.type)
-    }
-  }
-
-  choose_nleqslv_method <- function(nleqslv.method) {
-    if (nleqslv.method == "nleqslv" || nleqslv.method == "Broyden") {
-      "Broyden"
-    } else if (nleqslv.method == "Newton") {
-      "Newton"
-    } else {
-      stop("Unsupported nleqslv.method: ", nleqslv.method)
-    }
-  }
-
-  get_obj_value <- switch(outcome.type,
-                          "COMPETING-RISK"   = function(p) drop(crossprod(obj$estimating_equation_i(p))),
-                          "SURVIVAL"         = function(p) drop(crossprod(obj$estimating_equation_s(p))),
-                          "BINOMIAL"         = function(p) drop(crossprod(obj$estimating_equation_s(p))),
-                          "PROPORTIONAL"     = function(p) drop(crossprod(obj$estimating_equation_p(p))),
-                          "POLY-PROPORTIONAL"= function(p) drop(crossprod(obj$estimating_equation_pp(p))),
-                          stop("Unknown outcome.type: ", outcome.type)
+  objective <- create_objective_environment(
+    outcome.type = outcome.type,
+    nuisance.model = nuisance.model,
+    normalized_data = normalized_data,
+    exposure = exposure,
+    estimand = estimand,
+    prob.bound = prob.bound,
+    optim.method = optim.method,
+    ip.weight = ip.weight,
+    ip.weight.matrix = ip.weight.matrix
   )
-
-  obj <- makeObjectiveFunction()
-  estimating_fun <- choose_estimating_equation(outcome.type, obj)
-  nleqslv_method  <- choose_nleqslv_method(nleqslv.method)
-  iteration <- 0L
-  max.absolute.difference <- Inf
-  out_nleqslv <- NULL
-  current_params <- alpha_beta_0
-  current_obj_value <- numeric(0)
-  trace_df  <- NULL
-  store_params <- TRUE
-
-  while ((iteration < optim.parameter4) & (max.absolute.difference > optim.parameter1)) {
-    iteration <- iteration + 1
-    prev_params <- current_params
-
-    out_nleqslv <- nleqslv(
-      prev_params,
-      estimating_fun,
-      method  = nleqslv_method,
-      control = list(maxit = optim.parameter5, allowSingular = FALSE)
-    )
-    new_params <- out_nleqslv$x
-
-    current_obj_value <- get_obj_value(new_params)
-    obj$setInitialCIFs(obj$getResults()$potential.CIFs)
-    ac <- assessConvergence(new_params, prev_params, current_obj_value, optim.parameter1, optim.parameter2, optim.parameter3)
-
-    nleqslv.info <- extractOptimizationInfo(out_nleqslv, nleqslv.method)
-    computation.time.second <- as.numeric((proc.time() - computation.time0)[3])
-
-    trace_df <- append_trace(
-      trace_df,
-      iteration = iteration,
-      computation.time.second = computation.time.second,
-      nleqslv.method = nleqslv.method,
-      nleqslv.info = nleqslv.info,
-      objective.function = ac$obj_value,
-      relative.difference = ac$relative.difference,
-      max.absolute.difference = ac$max.absolute.difference,
-      converged.by = if (ac$converged) ac$converged.by else FALSE,
-      coefficient = if (store_params) new_params else NULL
-    )
-
-    current_params <- new_params
-    converged.by <- ac$converged.by
-    objective.function = ac$obj_value
-    max.absolute.difference <- ac$max.absolute.difference
-    relative.difference <- ac$relative.difference
-    if (ac$converged) break
-  }
-  out_getResults <- obj$getResults()
+  nleqslv_method <- resolve_nleqslv_method(nleqslv.method)
+  optimization <- run_root_finding(
+    initial_params = alpha_beta_0,
+    outcome.type = outcome.type,
+    objective = objective,
+    optim.method = optim.method,
+    nleqslv_method = nleqslv_method,
+    method_label = nleqslv.method,
+    computation.time0 = computation.time0,
+    track_trace = TRUE
+  )
+  current_params <- optimization$params
+  trace_df <- optimization$trace
+  iteration <- optimization$iteration
+  converged.by <- optimization$converged_by
+  objective.function <- optimization$objective_value
+  max.absolute.difference <- optimization$max_diff
+  relative.difference <- optimization$relative_diff
+  out_nleqslv <- optimization$solution
+  out_getResults <- objective$get_results()
 
   #######################################################################################################
   # 5. Calculating variance (functions: calculateCov, calculateCovSurvival)
   #######################################################################################################
   normalizeEstimate <- function(
     outcome.type,
     report.sandwich.conf,
     should.normalize.covariate,
     current_params,
     out_getResults,
     estimand,
     prob.bound,
     out_normalizeCovariate
   ) {
     if (report.sandwich.conf == FALSE) {
       alpha_beta_estimated <- if (should.normalize.covariate) {
         adj <- 1 / as.vector(out_normalizeCovariate$range)
         if (length(adj) != length(current_params)) stop("Length of adj (range) must match length of current_params.")
         adj * current_params
       } else {
         current_params
       }
       return(list(alpha_beta_estimated = alpha_beta_estimated, cov_estimated = NULL))
     }
     if (should.normalize.covariate) { #–{—ˆ‚Íoutcome.type‚Å•ªŠò‚ª•K—v
